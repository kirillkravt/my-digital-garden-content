#!/bin/bash
# –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤

echo "=== –ü–†–û–°–¢–û–ï –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í ==="
echo "–î–æ–±–∞–≤–ª—è–µ–º ID –∏–∑ frontmatter –≤ –Ω–∞—á–∞–ª–æ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞"
echo ""

# –°–æ–∑–¥–∞–µ–º backup
backup_dir="simple-rename-backup-$(date +%Y%m%d-%H%M%S)"
mkdir -p "$backup_dir"
echo "üìÅ Backup: $backup_dir"
echo ""

count=0
success=0
errors=0

# –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ .md —Ñ–∞–π–ª—ã (–Ω–µ —à–∞–±–ª–æ–Ω—ã, –Ω–µ Zettel)
for file in [0-9]*.md [A-F]*.md; do
    [ -f "$file" ] || continue
    
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —Ü–∏—Ñ—Ä—ã-—Ç–∏—Ä–µ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —É–∂–µ –∏–º–µ–µ—Ç ID)
    if [[ "$file" =~ ^[0-9A-F]{2}- ]]; then
        echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º (—É–∂–µ –∏–º–µ–µ—Ç ID): $file"
        continue
    fi
    
    echo "üîç –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º: $file"
    
    # –ò—â–µ–º ID –≤ —Ñ–∞–π–ª–µ
    id_line=$(grep -E '^id:' "$file" 2>/dev/null | head -1)
    
    if [ -z "$id_line" ]; then
        echo "   ‚ùå –ù–µ—Ç –ø–æ–ª—è id. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
        errors=$((errors + 1))
        echo ""
        continue
    fi
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–ø–æ—Å–æ–±)
    id=$(echo "$id_line" | sed 's/id://' | sed 's/"//g' | sed "s/'//g" | tr -d ' ')
    
    if [ -z "$id" ]; then
        echo "   ‚ùå –ü—É—Å—Ç–æ–π ID. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
        errors=$((errors + 1))
        echo ""
        continue
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ ID –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ HEX (–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç)
    if ! [[ "$id" =~ ^[0-9A-F]{2}(-[0-9A-F]{2})*$ ]]; then
        echo "   ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID: $id. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º."
        errors=$((errors + 1))
        echo ""
        continue
    fi
    
    count=$((count + 1))
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤–æ–µ –∏–º—è —Ñ–∞–π–ª–∞
    # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å " - " –≤ –∏–º–µ–Ω–∏, –±–µ—Ä–µ–º —á–∞—Å—Ç—å –ø–æ—Å–ª–µ –Ω–µ–≥–æ
    if [[ "$file" == *" - "* ]]; then
        name_part=$(echo "$file" | sed 's/.* - //')
        new_file="$id - $name_part"
    else
        new_file="$id - $file"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º
    if [ -f "$new_file" ] && [ "$file" != "$new_file" ]; then
        echo "   ‚ö†Ô∏è  –§–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $new_file"
        # –î–æ–±–∞–≤–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å
        base_name=$(basename "$new_file" .md)
        new_file="${base_name}-renamed.md"
        echo "   üí° –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∫–∞–∫: $new_file"
    fi
    
    # –°–æ–∑–¥–∞–µ–º backup
    cp "$file" "$backup_dir/"
    
    # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º
    echo "   üîß $file ‚Üí $new_file"
    mv "$file" "$new_file"
    
    if [ $? -eq 0 ]; then
        echo "   ‚úÖ –£—Å–ø–µ—à–Ω–æ"
        success=$((success + 1))
    else
        echo "   ‚ùå –û—à–∏–±–∫–∞"
        errors=$((errors + 1))
    fi
    
    echo ""
done

echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢ ==="
echo "–ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: $count"
echo "‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ: $success"
echo "‚ùå –û—à–∏–±–æ–∫: $errors"
echo "üìÅ Backup —Å–æ–∑–¥–∞–Ω –≤: $backup_dir"
echo ""

if [ $success -gt 0 ]; then
    echo "üéâ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –≤—Ä—É—á–Ω—É—é."
fi
