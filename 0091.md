## **1. Контекст и постановка проблемы**

Заказчик испытывает недостаток информации для мониторинга и анализа работы компонентов, ответственных за 3D Secure аутентификацию. В существующих системах (EPG и 3DSS) присутствуют в основном технические метрики (Actuator/JMX), но отсутствуют **бизнес-метрики**, отражающие ключевые показатели процесса аутентификации: количество и статусы сообщений по протоколам 3DS 1.0.2 и 3DS 2.0.

Отсутствие таких данных затрудняет оперативный контроль качества обслуживания, анализ причин отказов и планирование нагрузок. Изначальный запрос включал вопросы по настройке мониторинга, но в ходе обсуждения был сформирован и согласован конкретный перечень необходимых бизнес-метрик, разделенных по системам.

## **2. Цели проекта**

Основная цель — **обеспечить прозрачность и контролируемость процессов 3D Secure** за счет внедрения набора ключевых бизнес-метрик в системах EPG и 3DS Server.

Конкретные цели:

1. **Для 3DS 2.0:** Реализовать сбор метрик в компоненте **3DS Server**, так как он является центральным узлом обработки для этого протокола.
    
2. **Для 3DS 1.0.2:** Реализовать сбор метрик в компоненте **EPG (MPI)**, так как он обрабатывает этот протокол.
    
3. **Исключить дублирование:** Не создавать одинаковые метрики в обеих системах, а чётко разделить ответственность в соответствии с архитектурой.
    
4. **Обеспечить техническую возможность сбора:** Подтвердить и обеспечить работу сбора метрик через агента Prometheus/JMX по аналогии с системой ACS.
    

## **3. Требования к метрикам для 3DS Server (3DS 2.0)**

Требуется реализовать в 3DS Server сбор следующих бизнес-метрик по протоколу 3DS 2.0. Метрики должны быть доступны для сбора через Prometheus.

### **3.1. Метрики по потоку аутентификации (AReq/ARes):**

- **AReq (App Request):** Количество отправленных AReq-сообщений в Directory Server (DS) с разбивкой по HTTP-статусу ответа (уже частично существует как `dsRequestsCounter`).
    
- **ARes (App Response):** Количество полученных ARes-сообщений от DS с разбивкой по значениям полей `transStatus` и `transStatusReason` (при наличии).
    

### **3.2. Метрики по потоку Challenge (CReq/CRes):**

- **CReq (Challenge Request):** Количество сформированных и отправленных (через браузер клиента) CReq-сообщений.
    
- **CRes (Challenge Response):** Количество полученных CRes-сообщений от ACS с разбивкой по значению поля `transStatus`.
    

### **3.3. Метрики по потоку RReq/RRes:**

- **RReq (Result Request):** Количество полученных RReq-сообщений от DS с разбивкой по всем возможным значениям полей `transStatus` и `transStatusReason` в соответствии со спецификацией EMV.
    
- **RRes (Result Response):** Количество отправленных RRes-сообщений (синхронных ответов на RReq) с разбивкой по значению поля `resultStatus` из самого сообщения RRes.
    

### **3.4. Метрика доступности инфраструктуры:**

- **Переключение на Fallback DS:** Метрика, фиксирующая факты переключения запросов на резервный Directory Server (`ds2.mirconnect.ru`) при недоступности основного (`ds1.mirconnect.ru`). Должна учитывать срабатывания при таймаутах или получении кодов ошибок (например, 500).
    

## **4. Требования к метрикам для EPG (3DS 1.0.2)**

Требуется реализовать в EPG (в компоненте MPI) сбор следующих бизнес-метрик по протоколу 3DS 1.0.2.

### **4.1. Метрики по потоку Verify Enrollment (VeReq/VeRes):**

- **VeReq (Verify Enrollment Request):** Количество отправленных VeReq-сообщений в DS.
    
- **VeRes (Verify Enrollment Response):** Количество полученных VeRes-сообщений от DS с разбивкой по значению поля `status`.
    

### **4.2. Метрики по потоку Payer Authentication (PaReq/PaRes):**

- **PaReq (Payer Authentication Request):** Количество сформированных и отправленных (через браузер клиента) PaReq-сообщений.
    
- **PaRes (Payer Authentication Response):** Количество полученных PaRes-сообщений от ACS с разбивкой по всем возможным значениям поля `transStatus`.
    

## **5. Нефункциональные требования и техническая реализация**

1. **Формат и сбор:** Все новые метрики должны быть доступны в формате, пригодном для сбора **агентом Prometheus** (через JMX или HTTP endpoint), по аналогии с настройкой для ACS.
    
2. **Именование и теги:** Метрики должны иметь понятные имена и использовать labels (теги) для детальной разбивки (например, `transStatus="Y"`, `transStatusReason="01"`).
    
3. **Производительность:** Внедрение метрик не должно оказывать существенного негативного влияния на производительность и время отклика систем EPG и 3DSS.
    
4. **Документация:** По итогам реализации необходимо предоставить обновлённый перечень доступных метрик с описанием.
    

## **6. Ограничения**

- Для сообщений **CReq** (3DS 2.0) и **PaReq** (3DS 1.0.2), которые передаются через браузер конечного клиента, невозможно отследить факт их успешной доставки до ACS. Метрика должна считать факт формирования и отправки сообщения клиенту.
    
- Метрика по переключению на Fallback DS применима только к **3DS Server (3DS 2.0)**. Для потока 3DS 1.0.2 в EPG аналогичная функциональность, согласно обсуждению, не реализована и не требуется в рамках данной задачи.