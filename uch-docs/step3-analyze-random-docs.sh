#!/bin/bash
# step3-analyze-random-docs.sh - –∞–Ω–∞–ª–∏–∑ 5 —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

echo "=== –®–ê–ì 3: –ê–ù–ê–õ–ò–ó 5 –°–õ–£–ß–ê–ô–ù–´–• –î–û–ö–£–ú–ï–ù–¢–û–í ==="
echo "–î–∞—Ç–∞: $(date)"
echo ""

cd /Users/kirillkravcov/obsidian/my-digital-garden-content/uch-docs || exit 1

# –ë–µ—Ä–µ–º 5 —Å–ª—É—á–∞–π–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å ID –≤ –Ω–∞—á–∞–ª–µ (—Ñ–æ—Ä–º–∞—Ç XX - Name.md)
RANDOM_FILES=$(find . -maxdepth 1 -name "*.md" -type f | grep -E '^\./[0-9A-F]{2}' | shuf -n 5)

echo "üìä –ê–Ω–∞–ª–∏–∑ 5 —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å ID:"
echo ""

COUNTER=1
for file in $RANDOM_FILES; do
    # –£–±–∏—Ä–∞–µ–º ./ –∏–∑ –Ω–∞—á–∞–ª–∞
    FILE_NAME=$(echo "$file" | sed 's|^\./||')
    
    echo "üîç –î–æ–∫—É–º–µ–Ω—Ç $COUNTER: $FILE_NAME"
    echo "----------------------------------------"
    
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ "–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
    if grep -q "–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø" "$FILE_NAME"; then
        echo "‚úÖ –ù–∞–π–¥–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ '–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø'"
        
        # –ù–∞—Ö–æ–¥–∏–º —Å—Ç—Ä–æ–∫—É —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
        HEADER_LINE=$(grep -n "–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø" "$FILE_NAME" | head -1 | cut -d: -f1)
        HEADER_CONTENT=$(sed -n "${HEADER_LINE}p" "$FILE_NAME")
        
        echo "   –°—Ç—Ä–æ–∫–∞ $HEADER_LINE: '$HEADER_CONTENT'"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∑–∞–≥–æ–ª–æ–≤–∫–∞
        if [[ "$HEADER_CONTENT" =~ ^### ]]; then
            echo "   –£—Ä–æ–≤–µ–Ω—å: ###"
        elif [[ "$HEADER_CONTENT" =~ ^## ]]; then
            echo "   –£—Ä–æ–≤–µ–Ω—å: ##"
        elif [[ "$HEADER_CONTENT" =~ ^# ]]; then
            echo "   –£—Ä–æ–≤–µ–Ω—å: #"
        else
            echo "   ‚ö†Ô∏è –ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"
        fi
        
        # –ò—â–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–Ω—è ## –∏–ª–∏ ###
        NEXT_HEADER_LINE=""
        NEXT_HEADER=""
        
        for i in $(seq $((HEADER_LINE + 1)) $((HEADER_LINE + 30))); do
            LINE=$(sed -n "${i}p" "$FILE_NAME")
            if [[ "$LINE" =~ ^##\  ]] || [[ "$LINE" =~ ^###\  ]]; then
                NEXT_HEADER_LINE=$i
                NEXT_HEADER="$LINE"
                break
            fi
        done
        
        if [ -n "$NEXT_HEADER_LINE" ]; then
            echo "   –°–ª–µ–¥—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (—Å—Ç—Ä–æ–∫–∞ $NEXT_HEADER_LINE): '$NEXT_HEADER'"
            BLOCK_SIZE=$((NEXT_HEADER_LINE - HEADER_LINE - 1))
            echo "   –†–∞–∑–º–µ—Ä –±–ª–æ–∫–∞: $BLOCK_SIZE —Å—Ç—Ä–æ–∫"
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫)
            echo "   –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ (–ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫):"
            START=$((HEADER_LINE + 1))
            END=$((HEADER_LINE + 5))
            if [ $END -gt $((NEXT_HEADER_LINE - 1)) ]; then
                END=$((NEXT_HEADER_LINE - 1))
            fi
            
            if [ $START -le $END ]; then
                sed -n "${START},${END}p" "$FILE_NAME" | sed 's/^/     > /'
                if [ $BLOCK_SIZE -gt 5 ]; then
                    echo "     ... –∏ –µ—â–µ $((BLOCK_SIZE - 5)) —Å—Ç—Ä–æ–∫"
                fi
            fi
        else
            echo "   ‚ö†Ô∏è –°–ª–µ–¥—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö 30 —Å—Ç—Ä–æ–∫–∞—Ö"
        fi
        
    else
        echo "‚ùå –ó–∞–≥–æ–ª–æ–≤–æ–∫ '–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø' –Ω–µ –Ω–∞–π–¥–µ–Ω"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        if grep -qi "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" "$FILE_NAME"; then
            echo "   ‚ö†Ô∏è –ù–æ –Ω–∞–π–¥–µ–Ω–æ '–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' –≤ –¥—Ä—É–≥–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ"
            grep -ni "–æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" "$FILE_NAME" | head -2 | sed 's/^/     ‚Ä¢ /'
        fi
    fi
    
    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–∞
    echo ""
    echo "üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ø–µ—Ä–≤—ã–µ 10 –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤):"
    grep -n -E "^#+\ " "$FILE_NAME" | head -10 | sed 's/^/   /'
    
    # 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ frontmatter
    echo ""
    if head -5 "$FILE_NAME" | grep -q "^---$"; then
        echo "‚úÖ –ò–º–µ–µ—Ç frontmatter"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º ID –≤ frontmatter
        FM_ID=$(grep -i "^id:" "$FILE_NAME" | head -1 | sed 's/id: *"*\([^"]*\)"*/\1/' | tr -d ' ' | tr -d '"')
        FILE_ID=$(echo "$FILE_NAME" | grep -o '^[0-9A-F]\{2\}')
        
        if [ -n "$FM_ID" ] && [ -n "$FILE_ID" ]; then
            if [[ "$FM_ID" == "$FILE_ID"* ]]; then
                echo "   ‚úÖ ID –≤ frontmatter —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞"
            else
                echo "   ‚ö†Ô∏è ID –≤ frontmatter ($FM_ID) –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å ID –≤ –∏–º–µ–Ω–∏ ($FILE_ID...)"
            fi
        fi
    else
        echo "‚ùå –ù–µ—Ç frontmatter"
    fi
    
    echo ""
    echo "========================================"
    echo ""
    
    COUNTER=$((COUNTER + 1))
done

echo "üìä –°–í–û–î–ö–ê –ü–û –ê–ù–ê–õ–ò–ó–£:"
echo "1. –§–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ '–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø': ## üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
echo "2. –°–ª–µ–¥—É—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫: –æ–±—ã—á–Ω–æ ## üéØ –û–ü–ò–°–ê–ù–ò–ï –∏–ª–∏ –¥—Ä—É–≥–æ–π ## –∑–∞–≥–æ–ª–æ–≤–æ–∫"
echo "3. –ë–ª–æ–∫ —É–¥–∞–ª—è–µ—Ç—Å—è –æ—Ç '–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø' –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —É—Ä–æ–≤–Ω—è ##"
echo ""
echo "‚úÖ –®–ê–ì 3 –ó–ê–í–ï–†–®–ï–ù"
echo ""
echo "üöÄ –°–õ–ï–î–£–Æ–©–ò–ô –®–ê–ì:"
echo "  –°–æ–∑–¥–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞ '–û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø'"