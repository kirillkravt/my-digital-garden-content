#!/bin/bash
# –ï–î–ò–ù–´–ô —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ UCH —Å hex-–Ω—É–º–µ—Ä–∞—Ü–∏–µ–π

set -euo pipefail

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
VAULT_PATH="/Users/kirillkravcov/obsidian/my-digital-garden-content/uch-docs"
cd "$VAULT_PATH" || exit 1

# --- –§—É–Ω–∫—Ü–∏–∏ ---
print_error() { echo -e "\033[0;31m‚ùå $1\033[0m" >&2; }
print_success() { echo -e "\033[0;32m‚úÖ $1\033[0m"; }
print_info() { echo -e "\033[0;34m‚ÑπÔ∏è  $1\033[0m"; }

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ ID
find_first_free_id() {
    local parent_id="$1"
    
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ child IDs
    local existing_ids=()
    for file in *.md; do
        if [[ "$file" =~ ^${parent_id}-([0-9a-fA-F]{2})\ -\ .*\.md$ ]]; then
            existing_ids+=("${BASH_REMATCH[1]}")
        fi
    done
    
    # –ï—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–µ–π, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 01
    if [ ${#existing_ids[@]} -eq 0 ]; then
        echo "01"
        return 0
    fi
    
    # –ò—â–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–ø—É—Å–∫ –æ—Ç 01 –¥–æ FF
    for i in {1..255}; do
        expected_id=$(printf "%02x" $i)
        found=0
        
        for existing in "${existing_ids[@]}"; do
            if [[ "$existing" == "$expected_id" ]]; then
                found=1
                break
            fi
        done
        
        if [ $found -eq 0 ]; then
            echo "$expected_id"
            return 0
        fi
    done
    
    # –ï—Å–ª–∏ –≤—Å–µ –∑–∞–Ω—è—Ç—ã, –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π –ø–æ—Å–ª–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ
    local max_id="00"
    for id in "${existing_ids[@]}"; do
        if [[ "$id" > "$max_id" ]]; then
            max_id="$id"
        fi
    done
    
    local next_val=$((16#$max_id + 1))
    printf "%02x" "$next_val"
}

# –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω—è
calculate_level() {
    local id="$1"
    if [ -z "$id" ]; then
        echo 0
    else
        local num_dashes=$(tr -cd '-' <<< "$id" | wc -c)
        echo $((num_dashes + 1))
    fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞
create_note_file() {
    local parent_id="$1"
    local child_id="$2"
    local title="$3"
    local tags="$4"
    
    local note_id="${parent_id}-${child_id}"
    local filename="${note_id} - ${title}.md"
    local parent_level=$(calculate_level "$parent_id")
    local note_level=$((parent_level + 1))
    
    cat > "$filename" << FILE_CONTENT
# ${note_id} - ${title}

## üìã –û–ë–©–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
- **–°—Ç–∞—Ç—É—Å**: üÜï –ù–û–í–´–ô –î–û–ö–£–ú–ï–ù–¢
- **–†–æ–¥–∏—Ç–µ–ª—å**: ${parent_id:-[–∫–æ—Ä–µ–Ω—å]}
- **ID**: \`${note_id}\`
- **–£—Ä–æ–≤–µ–Ω—å**: ${note_level}
- **–¢–µ–≥–∏**: ${tags}

## üéØ –û–ü–ò–°–ê–ù–ò–ï

*–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–¥–µ—Å—å...*

## üìã –ó–ê–î–ê–ß–ò

- [ ] –ó–∞–¥–∞—á–∞ 1
- [ ] –ó–∞–¥–∞—á–∞ 2

## üîó –°–í–Ø–ó–ê–ù–ù–´–ï –î–û–ö–£–ú–ï–ù–¢–´

### –†–û–î–ò–¢–ï–õ–¨–°–ö–ò–ï:
${parent_id:+- [[${parent_id}]]}

### –î–û–ß–ï–†–ù–ò–ï:
*–ü–æ–∫–∞ –Ω–µ—Ç*

### –°–ú–ï–ñ–ù–´–ï:
*–î–æ–±–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫–∏...*

---
*–°–æ–∑–¥–∞–Ω–æ: $(date +%Y-%m-%d)*
*–°—Ç–∞—Ç—É—Å: –ß–µ—Ä–Ω–æ–≤–∏–∫*
FILE_CONTENT
    
    echo "$filename"
}

# –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞
update_parent_file() {
    local parent_id="$1"
    local note_id="$2"
    local title="$3"
    
    local parent_file="${parent_id} - "*.md
    parent_file=$(ls $parent_file 2>/dev/null | head -n1)
    
    if [ -z "$parent_file" ]; then
        print_info "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: ${parent_id}"
        return 0
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—Å—ã–ª–∫–∞
    if grep -q "\[\[${note_id} -" "$parent_file"; then
        print_info "–°—Å—ã–ª–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —Ñ–∞–π–ª–µ"
        return 0
    fi
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
    if grep -q "### –î–û–ß–ï–†–ù–ò–ï:" "$parent_file"; then
        sed -i '' "/### –î–û–ß–ï–†–ù–ò–ï:/a\\
- [[${note_id} - ${title}]]" "$parent_file"
    else
        # –ò—â–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å ---
        if grep -q "^---" "$parent_file"; then
            local line_num=$(grep -n "^---" "$parent_file" | head -1 | cut -d: -f1)
            sed -i '' "${line_num}i\\
\\
### –î–û–ß–ï–†–ù–ò–ï:\\
- [[${note_id} - ${title}]]" "$parent_file"
        else
            echo "" >> "$parent_file"
            echo "### –î–û–ß–ï–†–ù–ò–ï:" >> "$parent_file"
            echo "- [[${note_id} - ${title}]]" >> "$parent_file"
        fi
    fi
}

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---
main() {
    if [ $# -lt 2 ]; then
        print_error "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 <parent_id> \"<note_title>\" [tags]"
        print_info "–ü—Ä–∏–º–µ—Ä—ã:"
        print_info "  $0 00-02-01 \"–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞\" @bug @audio"
        print_info "  $0 00-02 \"–ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç\" @arch"
        print_info "  $0 \"\" \"–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç\" @project"
        exit 1
    fi
    
    local parent_id="$1"
    local note_title="$2"
    local tags="${3:-@todo}"
    
    print_info "–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–µ UCH..."
    
    # –ù–∞—Ö–æ–¥–∏–º —Å–≤–æ–±–æ–¥–Ω—ã–π ID
    print_info "–ü–æ–∏—Å–∫ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ ID –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª—è: ${parent_id:-[–∫–æ—Ä–µ–Ω—å]}"
    local child_id=$(find_first_free_id "$parent_id")
    local note_id="${parent_id:+"${parent_id}-"}${child_id}"
    
    print_success "–ù–∞–π–¥–µ–Ω ID: ${note_id}"
    
    # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª
    print_info "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞..."
    local filename=$(create_note_file "$parent_id" "$child_id" "$note_title" "$tags")
    print_success "–§–∞–π–ª —Å–æ–∑–¥–∞–Ω: ${filename}"
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª (–µ—Å–ª–∏ –Ω–µ –∫–æ—Ä–Ω–µ–≤–æ–π —É—Ä–æ–≤–µ–Ω—å)
    if [ -n "$parent_id" ] && [ "$parent_id" != "00" ]; then
        print_info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —Ñ–∞–π–ª–∞..."
        update_parent_file "$parent_id" "$note_id" "$note_title"
        print_success "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
    fi
    
    print_success "üéâ –ó–∞–º–µ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!"
    echo ""
    print_info "ID: ${note_id}"
    print_info "–§–∞–π–ª: ${filename}"
    print_info "–¢–µ–≥–∏: ${tags}"
}

main "$@"
