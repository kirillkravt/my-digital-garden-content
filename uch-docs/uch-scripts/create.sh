#!/bin/bash
# –ú–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã ID

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –µ—Å–ª–∏ –µ—Å—Ç—å
if [ -f "$SCRIPT_DIR/document-creator.sh" ]; then
    source "$SCRIPT_DIR/document-creator.sh"
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä ID
if [ -f "$SCRIPT_DIR/id-generator-v2.sh" ]; then
    source "$SCRIPT_DIR/id-generator-v2.sh"
fi

# –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ (—Å –Ω–æ–≤—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏)
create_document_improved() {
    echo ""
    echo "üìù –°–û–ó–î–ê–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê (–ù–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê ID)"
    echo ""
    
    # 1. –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è
    echo "=== –í–´–ë–û–† –£–†–û–í–ù–Ø –î–û–ö–£–ú–ï–ù–¢–ê ==="
    echo "1 - –ü—Ä–æ–µ–∫—Ç (—É—Ä–æ–≤–µ–Ω—å 1, –∫–æ—Ä–Ω–µ–≤–æ–π) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 1-010000-1"
    echo "2 - –õ–∏–Ω–∏—è/–ö–æ–º–ø–æ–Ω–µ–Ω—Ç (—É—Ä–æ–≤–µ–Ω—å 2-3) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 2-010400-1, 3-010401-1"
    echo "3 - –ó–∞–¥–∞—á–∞/–†–µ—à–µ–Ω–∏–µ (—É—Ä–æ–≤–µ–Ω—å 4-5) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 4-010400-0100-1, 5-010400-010001-1"
    echo "4 - –û—Ç—á–µ—Ç (—É—Ä–æ–≤–µ–Ω—å 6) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 6-010400-001-1"
    echo "5 - –ù–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç (–∏–¥–µ–∏, –≤—Å—Ç—Ä–µ—á–∏, —Å—Å—ã–ª–∫–∏)"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä (1-5): " level_choice
    
    local level=""
    local parent_id=""
    local level_name=""
    
    case $level_choice in
        1)
            level=1
            level_name="–ü—Ä–æ–µ–∫—Ç (—É—Ä–æ–≤–µ–Ω—å 1)"
            echo "–í—ã–±—Ä–∞–Ω: $level_name"
            echo "–ü—Ä–∏–º–µ—Ä ID: 1-010000-1 (PROD), 1-010000-7 (ARCH)"
            ;;
        2)
            # –£—Ä–æ–≤–µ–Ω—å 2 –∏–ª–∏ 3
            echo ""
            echo "=== –í–´–ë–û–† –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –£–†–û–í–ù–Ø ==="
            echo "1 - –õ–∏–Ω–∏—è —Ä–∞–∑–≤–∏—Ç–∏—è (—É—Ä–æ–≤–µ–Ω—å 2) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 2-010400-1"
            echo "2 - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —Å–∏—Å—Ç–µ–º—ã (—É—Ä–æ–≤–µ–Ω—å 3) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 3-010401-1"
            read -p "–í–∞—à –≤—ã–±–æ—Ä (1-2): " sub_choice
            
            case $sub_choice in
                1) level=2; level_name="–õ–∏–Ω–∏—è (—É—Ä–æ–≤–µ–Ω—å 2)" ;;
                2) level=3; level_name="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç (—É—Ä–æ–≤–µ–Ω—å 3)" ;;
                *) 
                    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                    return 1
                    ;;
            esac
            
            echo ""
            echo "–í—ã–±—Ä–∞–Ω: $level_name"
            read -p "–í–≤–µ–¥–∏—Ç–µ ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1-010000-1 –¥–ª—è —É—Ä–æ–≤–Ω—è 2, 2-010400-1 –¥–ª—è —É—Ä–æ–≤–Ω—è 3): " parent_id
            
            if [ -z "$parent_id" ]; then
                echo "‚ö†Ô∏è  ID —Ä–æ–¥–∏—Ç–µ–ª—è –Ω–µ —É–∫–∞–∑–∞–Ω. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç –±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è."
            else
                echo "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: $parent_id"
            fi
            ;;
        3)
            # –£—Ä–æ–≤–µ–Ω—å 4 –∏–ª–∏ 5
            echo ""
            echo "=== –í–´–ë–û–† –ö–û–ù–ö–†–ï–¢–ù–û–ì–û –£–†–û–í–ù–Ø ==="
            echo "1 - –ó–∞–¥–∞—á–∞ (—É—Ä–æ–≤–µ–Ω—å 4) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 4-010400-0100-1"
            echo "2 - –†–µ—à–µ–Ω–∏–µ (—É—Ä–æ–≤–µ–Ω—å 5) - –Ω–∞–ø—Ä–∏–º–µ—Ä: 5-010400-010001-1"
            read -p "–í–∞—à –≤—ã–±–æ—Ä (1-2): " sub_choice
            
            case $sub_choice in
                1) level=4; level_name="–ó–∞–¥–∞—á–∞ (—É—Ä–æ–≤–µ–Ω—å 4)" ;;
                2) level=5; level_name="–†–µ—à–µ–Ω–∏–µ (—É—Ä–æ–≤–µ–Ω—å 5)" ;;
                *) 
                    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
                    return 1
                    ;;
            esac
            
            echo ""
            echo "–í—ã–±—Ä–∞–Ω: $level_name"
            read -p "–í–≤–µ–¥–∏—Ç–µ ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 3-010401-1 –¥–ª—è –∑–∞–¥–∞—á–∏, 4-010400-0100-1 –¥–ª—è —Ä–µ—à–µ–Ω–∏—è): " parent_id
            
            if [ -z "$parent_id" ]; then
                echo "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –î–ª—è —É—Ä–æ–≤–Ω—è $level —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–∫–∞–∑–∞—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π ID."
                read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è? (y/n): " confirm
                if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
                    return 1
                fi
            else
                echo "–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç: $parent_id"
            fi
            ;;
        4)
            level=6
            level_name="–û—Ç—á–µ—Ç (—É—Ä–æ–≤–µ–Ω—å 6)"
            echo "–í—ã–±—Ä–∞–Ω: $level_name"
            echo "–ü—Ä–∏–º–µ—Ä ID: 6-010400-001-1 (REPORT)"
            
            echo ""
            read -p "–í–≤–µ–¥–∏—Ç–µ ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–∞–ø—Ä–∏–º–µ—Ä: 2-010400-1): " parent_id
            ;;
        5)
            level="N"
            level_name="–ù–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç"
            echo "–í—ã–±—Ä–∞–Ω: $level_name"
            echo "–ü—Ä–∏–º–µ—Ä ID: Z-20260204123000 (IDEA), M-20260204 (MEETING)"
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            return 1
            ;;
    esac
    
    # 2. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: " name
    if [ -z "$name" ]; then
        echo "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
        return 1
    fi
    
    # 3. –í—ã–±–æ—Ä —Ç–∏–ø–∞
    echo ""
    echo "=== –í–´–ë–û–† –¢–ò–ü–ê –î–û–ö–£–ú–ï–ù–¢–ê ==="
    
    if [ -f "$SCRIPT_DIR/types.sh" ]; then
        source "$SCRIPT_DIR/types.sh"
        
        if [ "$level" = "N" ]; then
            echo "–¢–∏–ø—ã –¥–ª—è –Ω–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:"
            echo "1 - idea (–ò–¥–µ—è/–∫–æ–Ω—Ü–µ–ø—Ü–∏—è)"
            echo "2 - reference (–°—Å—ã–ª–∫–∞/—Ä–µ—Å—É—Ä—Å)"
            echo "3 - meeting (–í—Å—Ç—Ä–µ—á–∞/–æ–±—Å—É–∂–¥–µ–Ω–∏–µ)"
            echo "4 - note (–ó–∞–º–µ—Ç–∫–∞)"
            echo ""
            read -p "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø (1-4): " type_choice
            
            case $type_choice in
                1) type="idea" ;;
                2) type="reference" ;;
                3) type="meeting" ;;
                4) type="note" ;;
                *) type="idea" ;;
            esac
        else
            show_type_menu_for_level "$level"
            type=$(select_type_by_number "$level")
        fi
    else
        # –§–æ–ª–±—ç–∫
        type=$(get_default_type_for_level "$level")
    fi
    
    echo "–í—ã–±—Ä–∞–Ω —Ç–∏–ø: $type"
    
    # 4. –¢–µ–≥–∏
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): " tags
    
    # 5. –°–≤–æ–¥–∫–∞
    echo ""
    echo "üìã –°–í–û–î–ö–ê:"
    echo "  –£—Ä–æ–≤–µ–Ω—å: $level ($level_name)"
    echo "  –ù–∞–∑–≤–∞–Ω–∏–µ: $name"
    echo "  –¢–∏–ø: $type"
    if [ -n "$parent_id" ]; then
        echo "  –†–æ–¥–∏—Ç–µ–ª—å: $parent_id"
    fi
    if [ -n "$tags" ]; then
        echo "  –¢–µ–≥–∏: $tags"
    fi
    
    # 6. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    echo ""
    read -p "–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç? (y/n): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
        return 1
    fi
    
    # 7. –°–æ–∑–¥–∞–Ω–∏–µ
    echo ""
    if create_real_document "$name" "$level" "$type" "$parent_id" "$tags"; then
        echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
create_batch_documents() {
    echo "–ü–∞–∫–µ—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –≤ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ"
    echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—ã—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"
    read -p "–ù–∞–∂–º–∏—Ç–µ Enter —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é..."
}