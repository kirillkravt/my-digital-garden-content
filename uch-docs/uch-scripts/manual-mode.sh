#!/bin/bash
# –†–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ (—Ä—É—á–Ω–æ–π ID) - –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å —Ä—É—á–Ω—ã–º —É–∫–∞–∑–∞–Ω–∏–µ–º ID
create_document_manual() {
    echo "üìù –°–û–ó–î–ê–ù–ò–ï –ü–û –ò–ú–ï–ù–ò (–†–£–ß–ù–û–ô ID - –ù–û–í–´–ô –§–û–†–ú–ê–¢)"
    echo ""
    
    # 1. –†—É—á–Ω–æ–π ID
    echo "=== –í–í–û–î ID –î–û–ö–£–ú–ï–ù–¢–ê ==="
    echo "–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö ID:"
    echo "  ‚Ä¢ 1-010000-1      (–ü—Ä–æ–µ–∫—Ç, —É—Ä–æ–≤–µ–Ω—å 1)"
    echo "  ‚Ä¢ 2-010400-7      (–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–∏–Ω–∏–∏, —É—Ä–æ–≤–µ–Ω—å 2)"
    echo "  ‚Ä¢ 3-010401-1      (–ö–æ–º–ø–æ–Ω–µ–Ω—Ç, —É—Ä–æ–≤–µ–Ω—å 3)"
    echo "  ‚Ä¢ 4-010400-0100-1 (–ó–∞–¥–∞—á–∞, —É—Ä–æ–≤–µ–Ω—å 4)"
    echo "  ‚Ä¢ 5-010400-010001-1 (–†–µ—à–µ–Ω–∏–µ, —É—Ä–æ–≤–µ–Ω—å 5)"
    echo "  ‚Ä¢ Z-20260204120000 (–ò–¥–µ—è, –Ω–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π)"
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ ID –¥–æ–∫—É–º–µ–Ω—Ç–∞: " manual_id
    
    if [ -z "$manual_id" ]; then
        echo "‚ùå ID –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç ID (–Ω–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
    if ! echo "$manual_id" | grep -qE '^([1-6]-[0-9]{6}-[0-9]+(-[0-9]+)?|Z-[0-9]{14}|M-[0-9]{8}|R-[0-9A-F]{6})$'; then
        echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: ID –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É"
        echo "   –§–æ—Ä–º–∞—Ç—ã: X-XXXXXX-X, X-XXXXXX-XXXX-X, Z-YYYYMMDDHHMMSS, M-YYYYMMDD, R-HEXCODE"
        read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            return 1
        fi
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∑–∞–Ω—è—Ç –ª–∏ ID
    if find . -maxdepth 1 -name "${manual_id}_*.md" -type f | grep -q .; then
        echo "‚ùå –û—à–∏–±–∫–∞: –î–æ–∫—É–º–µ–Ω—Ç —Å ID '$manual_id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
        echo "   –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã:"
        find . -maxdepth 1 -name "${manual_id}_*.md" -type f | head -3
        return 1
    fi
    
    # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∏–∑ ID
    local level=""
    if [[ "$manual_id" =~ ^[1-6]- ]]; then
        level=$(echo "$manual_id" | cut -d'-' -f1)
        echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: $level"
    elif [[ "$manual_id" =~ ^Z- ]]; then
        level="N"
        echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: N (–Ω–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π, –∏–¥–µ—è)"
    elif [[ "$manual_id" =~ ^M- ]]; then
        level="N"
        echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: N (–Ω–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π, –≤—Å—Ç—Ä–µ—á–∞)"
    elif [[ "$manual_id" =~ ^R- ]]; then
        level="N"
        echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: N (–Ω–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–π, —Å—Å—ã–ª–∫–∞)"
    else
        echo "‚ö†Ô∏è  –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∏–∑ ID"
        read -p "–í–≤–µ–¥–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å –≤—Ä—É—á–Ω—É—é (1-6 –∏–ª–∏ N): " level
    fi
    
    # 3. –ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞: " name
    if [ -z "$name" ]; then
        echo "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
        return 1
    fi
    
    # 4. –í—ã–±–æ—Ä —Ç–∏–ø–∞
    echo ""
    if [ -f "$SCRIPT_DIR/types.sh" ]; then
        source "$SCRIPT_DIR/types.sh"
        show_type_menu_for_level "$level"
        type=$(select_type_by_number "$level")
    else
        type=$(get_default_type_for_level "$level")
    fi
    
    # 5. –¢–µ–≥–∏
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): " tags
    
    # 6. –†–æ–¥–∏—Ç–µ–ª—å (–µ—Å–ª–∏ –µ—Å—Ç—å –≤ ID –∏ —É—Ä–æ–≤–µ–Ω—å > 1)
    local parent_id=""
    if [[ "$manual_id" =~ ^[2-6]- ]] && [[ "$level" =~ ^[2-6]$ ]]; then
        echo ""
        read -p "–í–≤–µ–¥–∏—Ç–µ ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å): " parent_id
    fi
    
    # 7. –°–≤–æ–¥–∫–∞
    echo ""
    echo "üìã –°–í–û–î–ö–ê:"
    echo "  ID: $manual_id"
    echo "  –£—Ä–æ–≤–µ–Ω—å: $level"
    echo "  –ù–∞–∑–≤–∞–Ω–∏–µ: $name"
    echo "  –¢–∏–ø: $type"
    if [ -n "$parent_id" ]; then
        echo "  –†–æ–¥–∏—Ç–µ–ª—å: $parent_id"
    fi
    if [ -n "$tags" ]; then
        echo "  –¢–µ–≥–∏: $tags"
    fi
    
    # 8. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    echo ""
    read -p "–°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç? (y/n): " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
        return 1
    fi
    
    # 9. –°–æ–∑–¥–∞–Ω–∏–µ —Å —Ä—É—á–Ω—ã–º ID
    echo ""
    if create_real_document "$name" "$level" "$type" "$parent_id" "$tags"; then
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º —Ñ–∞–π–ª —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä—É—á–Ω–æ–π ID
        # –ù–∞—Ö–æ–¥–∏–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–æ–∑–¥–∞–Ω–Ω—ã–π)
        latest_file=$(ls -t *.md | head -1)
        if [ -f "$latest_file" ]; then
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ä—É—á–Ω—ã–º ID
            short_type=$(get_short_type "$type")
            slug=$(echo "$name" | tr ' ' '_' | tr '[:upper:]' '[:lower:]' | tr -cd '[:alnum:]_')
            correct_name="${manual_id}_${short_type}_${slug}.md"
            
            if [ "$latest_file" != "$correct_name" ]; then
                mv "$latest_file" "$correct_name"
                echo "‚úÖ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω –≤: $correct_name"
                
                # –û–±–Ω–æ–≤–ª—è–µ–º ID –≤ frontmatter –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                sed -i '' "s/^id:.*/id: \"$manual_id\"/" "$correct_name"
            fi
            
            echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω —Å —Ä—É—á–Ω—ã–º ID: $manual_id"
        else
            echo "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω"
        fi
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
        return 1
    fi
}