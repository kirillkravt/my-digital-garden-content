// üöÄ UPDATED: 1766135205 - CUSTOM STRUDEL BUNDLE VERSION
// src/core/StrudelREPLNode.tsx - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ö–ê–°–¢–û–ú–ù–´–ú –ë–ê–ù–î–õ–û–ú
declare global {
  interface Window {
    __strudelLoaded?: boolean;
    __strudelCustomBundleLoaded?: boolean;
  }
}

import React, { useEffect, useRef, useState } from 'react';

interface StrudelREPLNodeProps {
  nodeId: string;
}

export const StrudelREPLNode: React.FC<StrudelREPLNodeProps> = ({ nodeId }) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [isInitialized, setIsInitialized] = useState(false);
  const [code, setCode] = useState('note("c4 e4 g4")');
  const audioContextRef = useRef<AudioContext | null>(null);
  const strudelLoadedRef = useRef(false);

  // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø STRUDEL –° –ö–ê–°–¢–û–ú–ù–´–ú –ë–ê–ù–î–õ–û–ú
  useEffect(() => {
    const initializeStrudel = async () => {
      if (window.__strudelLoaded) {
        audioContextRef.current = window.strudel?.getAudioContext() || null;
        setIsInitialized(true);
        return;
      }

      if (strudelLoadedRef.current) return;

      try {
        console.log('üîÑ StrudelREPLNode: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –±–∞–Ω–¥–ª–æ–º...');
        
        if (!window.strudel && !window.__strudelCustomBundleLoaded) {
          await new Promise<void>((resolve, reject) => {
            // –ü–ï–†–í–´–ô –ü–†–ò–û–†–ò–¢–ï–¢: –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–Ω–¥–ª
            const script = document.createElement('script');
            script.src = '/strudel-bundle.umd.cjs?cache=' + Date.now() + Math.random();
            script.id = 'uch-strudel-custom-bundle';
            
            script.onload = async () => {
              console.log('‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–π Strudel –±–∞–Ω–¥–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
              window.__strudelCustomBundleLoaded = true;
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞—à–µ–≥–æ –±–∞–Ω–¥–ª–∞
              if (window.initStrudel) {
                try {
                  await window.initStrudel();
                  console.log('‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–π Strudel –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å MIDI –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π');
                  resolve();
                } catch (initError) {
                  console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±–∞–Ω–¥–ª–∞:', initError);
                  reject(initError);
                }
              } else {
                console.error('‚ùå initStrudel –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–º –±–∞–Ω–¥–ª–µ');
                reject(new Error('initStrudel not found in custom bundle'));
              }
            };
            
            script.onerror = (error) => {
              console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±–∞–Ω–¥–ª–∞:', error);
              reject(new Error('Failed to load custom bundle'));
            };
            
            document.head.appendChild(script);
          });
        } else if (window.strudel && window.__strudelCustomBundleLoaded) {
          console.log('‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–Ω–¥–ª —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        }

        if (window.initStrudel && !window.__strudelLoaded) {
          await window.initStrudel();
        }

        audioContextRef.current = window.strudel?.getAudioContext() || null;
        window.__strudelLoaded = true;
        strudelLoadedRef.current = true;
        setIsInitialized(true);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ MIDI —Ñ—É–Ω–∫—Ü–∏–∏
        if (window.note) {
          const testPattern = window.note("c4");
          if (testPattern.midi && typeof testPattern.midi === 'function') {
            console.log('‚úÖ MIDI –º–µ—Ç–æ–¥ .midi() –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–º –±–∞–Ω–¥–ª–µ');
          } else {
            console.warn('‚ö†Ô∏è –ú–µ—Ç–æ–¥ .midi() –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω');
          }
        }
        
        console.log('‚úÖ Strudel –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –±–∞–Ω–¥–ª–æ–º');
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Strudel:', error);
        // –ù–µ –ø–∞–¥–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
      }
    };

    initializeStrudel();

    return () => {
      if (audioContextRef.current) {
        audioContextRef.current.close();
      }
    };
  }, []);

  // 2. PLAY - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ê–ö–¢–ò–í–ê–¶–ò–ï–ô AUDIOCONTEXT
  const handlePlay = async () => {
    if (!window.strudel) {
      console.error('‚ùå Strudel –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      return;
    }

    try {
      console.log('‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ...');
      
      // –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π AudioContext
      let audioContext = audioContextRef.current;
      
      // –ï—Å–ª–∏ AudioContext –Ω–µ—Ç, –ø–æ–ª—É—á–∞–µ–º –µ–≥–æ —á–µ—Ä–µ–∑ strudel
      if (!audioContext) {
        audioContext = window.strudel.getAudioContext();
        audioContextRef.current = audioContext;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ AudioContext
      console.log('AudioContext —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ:', audioContext?.state);
      
      // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º AudioContext –µ—Å–ª–∏ –æ–Ω –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ suspended
      if (audioContext && audioContext.state === 'suspended') {
        console.log('üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è AudioContext...');
        await audioContext.resume();
        console.log('AudioContext —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ resume:', audioContext.state);
      } else if (audioContext && audioContext.state === 'running') {
        console.log('‚úÖ AudioContext —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω');
      } else if (!audioContext) {
        console.error('‚ùå AudioContext –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
        return;
      }
      
      // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–¥ Strudel
      window.strudel.evaluate(code);
      setIsPlaying(true);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ:', error);
      setIsPlaying(false);
    }
  };

  // 3. STOP - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
  const handleStop = async () => {
    if (!window.strudel) {
      return;
    }

    try {
      console.log('‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∫–∞...');
      const audioContext = audioContextRef.current || window.strudel.getAudioContext();
      if (audioContext) {
        await audioContext.suspend();
      }
      setIsPlaying(false);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ:', error);
    }
  };

  // 4. TEST MIDI - —Ç–µ—Å—Ç–∏—Ä—É–µ–º –º–µ—Ç–æ–¥ .midi() –∏–∑ –Ω–∞—à–µ–≥–æ –±–∞–Ω–¥–ª–∞
  const testMidi = async () => {
    if (!window.strudel || !window.note) {
      console.error('‚ùå Strudel –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      return;
    }

    try {
      console.log('üéµ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ MIDI –∏–∑ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –±–∞–Ω–¥–ª–∞...');
      const pattern = window.note("c4 e4 g4");
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–∞ .midi()
      if (pattern.midi && typeof pattern.midi === 'function') {
        console.log('‚úÖ –ú–µ—Ç–æ–¥ .midi() –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–º –±–∞–Ω–¥–ª–µ');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º MIDI —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–∞–Ω–∞–ª 1)
        pattern.midi({ channel: 1 });
        console.log('‚úÖ MIDI —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–Ω–¥–ª');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—à –±–∞–Ω–¥–ª
        if (window.__strudelCustomBundleLoaded) {
          console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–Ω–¥–ª —Å MIDI –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π');
        } else {
          console.warn('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ù–ï –∫–∞—Å—Ç–æ–º–Ω—ã–π –±–∞–Ω–¥–ª');
        }
      } else {
        console.error('‚ùå –ú–µ—Ç–æ–¥ .midi() –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è CDN –≤–µ—Ä—Å–∏—è –±–µ–∑ MIDI');
        console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤:', {
          pattern,
          hasMidi: pattern.midi,
          windowStrudel: window.strudel,
          customBundleLoaded: window.__strudelCustomBundleLoaded
        });
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ MIDI:', error);
    }
  };

  // 5. –ü–†–û–í–ï–†–ö–ê –ë–ê–ù–î–õ–ê - –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
  const checkBundle = () => {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –±–∞–Ω–¥–ª–∞:', {
      hasWindowStrudel: !!window.strudel,
      hasInitStrudel: !!window.initStrudel,
      hasNote: !!window.note,
      customBundleLoaded: window.__strudelCustomBundleLoaded,
      strudelLoaded: window.__strudelLoaded,
      audioContext: audioContextRef.current?.state
    });
    
    if (window.note) {
      const testPattern = window.note("c4");
      console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–æ–¥–∞ .midi() –Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–µ:', {
        pattern: testPattern,
        hasMidiMethod: testPattern.midi && typeof testPattern.midi === 'function',
        midiFunction: testPattern.midi
      });
    }
  };

  return (
    <div className="strudel-repl-node" style={{ padding: '1rem', border: '1px solid #ccc', borderRadius: '8px' }}>
      <h3>Strudel REPL Node</h3>
      <p>Node ID: {nodeId}</p>
      <p>–ë–∞–Ω–¥–ª: {window.__strudelCustomBundleLoaded ? '‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–π' : '‚ö†Ô∏è CDN'}</p>
      
      <div style={{ marginBottom: '1rem' }}>
        <textarea 
          value={code}
          onChange={(e) => setCode(e.target.value)}
          rows={3}
          style={{ width: '100%', padding: '0.5rem' }}
          placeholder="–í–≤–µ–¥–∏—Ç–µ Strudel –∫–æ–¥..."
        />
      </div>

      <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1rem', flexWrap: 'wrap' }}>
        <button 
          onClick={handlePlay} 
          disabled={!isInitialized || isPlaying}
          style={{ padding: '0.5rem 1rem', backgroundColor: isPlaying ? '#ccc' : '#4CAF50', color: 'white', border: 'none', borderRadius: '4px' }}
        >
          {isPlaying ? '–ò–≥—Ä–∞–µ—Ç...' : '‚ñ∂Ô∏è Play'}
        </button>
        
        <button 
          onClick={handleStop}
          disabled={!isPlaying}
          style={{ padding: '0.5rem 1rem', backgroundColor: '#f44336', color: 'white', border: 'none', borderRadius: '4px' }}
        >
          ‚èπÔ∏è Stop
        </button>

        <button 
          onClick={testMidi}
          disabled={!isInitialized}
          style={{ padding: '0.5rem 1rem', backgroundColor: '#2196F3', color: 'white', border: 'none', borderRadius: '4px' }}
        >
          üéµ Test MIDI
        </button>

        <button 
          onClick={checkBundle}
          style={{ padding: '0.5rem 1rem', backgroundColor: '#9C27B0', color: 'white', border: 'none', borderRadius: '4px' }}
        >
          üîç Check Bundle
        </button>
      </div>

      <div style={{ fontSize: '0.9rem', color: '#666' }}>
        <p>–°—Ç–∞—Ç—É—Å: {isInitialized ? '‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...'}</p>
        <p>–ë–∞–Ω–¥–ª: {window.__strudelCustomBundleLoaded ? '‚úÖ –ö–∞—Å—Ç–æ–º–Ω—ã–π' : '‚ö†Ô∏è CDN (–±–µ–∑ MIDI)'}</p>
        <p>AudioContext: {audioContextRef.current?.state || '–Ω–µ —Å–æ–∑–¥–∞–Ω'}</p>
      </div>
    </div>
  );
};
