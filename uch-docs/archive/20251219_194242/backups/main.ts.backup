// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
import { strudelController } from "./strudel-controller";

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —è–¥—Ä–æ –∏ webaudio
import * as core from '@strudel/core';
import * as webaudio from '@strudel/webaudio';

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–ª–∞–≥–∏–Ω—ã
import '@strudel/midi';
import '@strudel/tonal';
import '@strudel/soundfonts'; // <-- –î–û–ë–ê–í–õ–ï–ù–û

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
declare global {
  interface Window {
    note: any;
    silence: any;
    seq: any;
    initStrudel: any;
    evaluate: any;
    webaudio: any;
    core: any;
    strudel: any;
    __strudelLoaded: boolean;
    strudelController: any; // <-- –î–û–ë–ê–í–õ–ï–ù–û
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏
export const { note, silence, seq } = core;
export const init = webaudio.initAudio;
export const evaluate = core.evaluate;
export const getAudioContext = webaudio.getAudioContext;

async function initStrudel() {
  if (window.__strudelLoaded) {
    console.warn('Strudel already loaded');
    return;
  }
  
  await init();
  window.__strudelLoaded = true;
  
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ <-- –î–û–ë–ê–í–õ–ï–ù–û
  console.log('Initializing StrudelController...');
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
export { initStrudel };

if (typeof window !== 'undefined') {
  window.initStrudel = initStrudel;
  
  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
  window.note = note;
  window.strudel = {
    evaluate: evaluate,
    getAudioContext: getAudioContext,
    hush: () => console.warn('hush() not implemented in custom bundle'),
  };
  
  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å <-- –î–û–ë–ê–í–õ–ï–ù–û
  window.strudelController = strudelController;
  
  // –î–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  console.log('Strudel bundle loaded, functions available:', {
    note: typeof note,
    strudel: typeof window.strudel,
    initStrudel: typeof window.initStrudel,
    hasSoundfonts: true
  });
  
  console.log("üéµ StrudelController –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ–º");
  console.log("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: strudelController.initialize() ‚Üí strudelController.play(code)");
  
  // –ê–≤—Ç–æ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∑–∞–ø—Ä–æ—Å—É
  window.addEventListener('load', () => {
    console.log('UCH Strudel bundle ready with soundfonts');
  });
}
