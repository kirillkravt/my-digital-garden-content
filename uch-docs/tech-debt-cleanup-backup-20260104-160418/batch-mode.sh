#!/bin/bash
# –ü–∞–∫–µ—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

# –ü–∞–∫–µ—Ç–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ–¥–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è
create_batch_documents() {
    echo ""
    echo "üì¶ –ü–ê–ö–ï–¢–ù–û–ï –°–û–ó–î–ê–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–û–í"
    echo ""
    
    # 1. –í—ã–±–æ—Ä —É—Ä–æ–≤–Ω—è
    echo "=== –í–´–ë–û–† –£–†–û–í–ù–Ø –î–õ–Ø –ü–ê–ö–ï–¢–ù–û–ì–û –°–û–ó–î–ê–ù–ò–Ø ==="
    echo "1 - –£—Ä–æ–≤–µ–Ω—å 1 (–º–∞—Å—Ç–µ—Ä-–¥–æ–∫—É–º–µ–Ω—Ç—ã)"
    echo "2 - –£—Ä–æ–≤–µ–Ω—å 2+ (–¥–æ—á–µ—Ä–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã)"
    echo "3 - –ù–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
    echo ""
    read -p "–í–∞—à –≤—ã–±–æ—Ä (1-3): " level_choice
    
    local level=""
    local parent_id=""
    
    case $level_choice in
        1)
            level=1
            echo "–í—ã–±—Ä–∞–Ω: –£—Ä–æ–≤–µ–Ω—å 1 (–º–∞—Å—Ç–µ—Ä-–¥–æ–∫—É–º–µ–Ω—Ç—ã)"
            ;;
        2)
            # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è
            echo ""
            read -p "–í–≤–µ–¥–∏—Ç–µ ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞: " parent_id
            
            if [ -z "$parent_id" ]; then
                echo "‚ùå ID —Ä–æ–¥–∏—Ç–µ–ª—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
                return 1
            fi
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
            parent_level=$(echo "$parent_id" | tr -cd '-' | wc -c)
            level=$((parent_level + 2))
            echo "–û–ø—Ä–µ–¥–µ–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å: $level (—Ä–æ–¥–∏—Ç–µ–ª—å: $parent_id)"
            ;;
        3)
            level="N"
            echo "–í—ã–±—Ä–∞–Ω: –ù–µ–∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã"
            ;;
        *)
            echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä"
            return 1
            ;;
    esac
    
    # 2. –í—ã–±–æ—Ä —Ç–∏–ø–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ø–∞–∫–µ—Ç–µ)
    echo ""
    if [ -f "$SCRIPT_DIR/types.sh" ]; then
        source "$SCRIPT_DIR/types.sh"
        show_type_menu_for_level "$level"
        type=$(select_type_by_number "$level")
    else
        type=$(get_default_type_for_level "$level")
    fi
    
    # 3. –û–±—â–∏–µ —Ç–µ–≥–∏ –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    echo ""
    read -p "–í–≤–µ–¥–∏—Ç–µ –æ–±—â–∏–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–æ –≤—Å–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º): " common_tags
    
    # 4. –°–æ–∑–¥–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    echo ""
    echo "=== –°–û–ó–î–ê–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–û–í ==="
    echo "–í–≤–æ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ø–æ –æ–¥–Ω–æ–º—É."
    echo "–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏–ª–∏ 'q'."
    echo ""
    
    local doc_count=0
    while true; do
        echo ""
        echo "–î–æ–∫—É–º–µ–Ω—Ç #$((doc_count + 1))"
        read -p "–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∏–ª–∏ Enter/q –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è): " doc_name
        
        if [ -z "$doc_name" ] || [ "$doc_name" = "q" ] || [ "$doc_name" = "Q" ]; then
            break
        fi
        
        # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏
        read -p "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ): " specific_tags
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ç–µ–≥–∏
        local all_tags="$common_tags"
        if [ -n "$specific_tags" ]; then
            if [ -n "$all_tags" ]; then
                all_tags="$all_tags,$specific_tags"
            else
                all_tags="$specific_tags"
            fi
        fi
        
        # –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        echo ""
        echo "–°–æ–∑–¥–∞—é: $doc_name"
        
        if create_real_document "$doc_name" "$level" "$type" "$parent_id" "$all_tags"; then
            doc_count=$((doc_count + 1))
            echo "‚úÖ –°–æ–∑–¥–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç #$doc_count"
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞"
        fi
    done
    
    echo ""
    echo "üìä –ò–¢–û–ì:"
    echo "  –°–æ–∑–¥–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: $doc_count"
    echo "  –£—Ä–æ–≤–µ–Ω—å: $level"
    echo "  –¢–∏–ø: $type"
    if [ -n "$parent_id" ]; then
        echo "  –†–æ–¥–∏—Ç–µ–ª—å: $parent_id"
    fi
    if [ -n "$common_tags" ]; then
        echo "  –û–±—â–∏–µ —Ç–µ–≥–∏: $common_tags"
    fi
}

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞ (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
create_batch_from_file() {
    local input_file="$1"
    
    echo "‚ö†Ô∏è  –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"
    echo "   –§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:"
    echo "   name,type,level,parent_id,tags"
    echo "   –ü—Ä–∏–º–µ—Ä:"
    echo "   '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞',task,3,00-01,bug,urgent"
}
